---
title: "nma"
description: |
  Work in progress.
author:
  - name: Charles T. Gray
    url: https://github.com/softloud/onetimetrophybitch
date: 09-06-2020
output:
  distill::distill_article:
    self_contained: false
    toc: true
    code_folding: show
  # html_document:
  #   number_sections: true
  #   toc: true
  #   toc_float: true
  #   code_folding: show
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
 cache = TRUE,
  echo = TRUE)

```

```{r}
# last updated
Sys.Date()
```


```{r message=FALSE}
# packages used in this blogpost

# general purpose
library(tidyverse) 
library(kableExtra) # tables
library(skimr) # summary
library(patchwork) # vis + vis

# toolchain walkthrough
library(multinma) # network meta-analysis
library(nmathresh) # threshold analysis
library(metafor) # for (non network) meta-analysis

# special purpose
library(fdrtool) # for halfnormal distribution
library(simeta) # borrowing some handy functions 
# note: should port these to my helper functions pkg

# for reproducibility
set.seed(40)

```


# network meta-analysis

Network meta-analysis is a statistical method for aggregating multiple pairwise comparisons on a response of interest [@higgins2019cochrane]. For example, perhaps three studies propose different treatments for a particular medical condition, network meta-analysis enables us to directly and indirectly compare the treatments' effects. Network meta-analysis is a technique for identifying _which_ treatments are more effective than others, rather than _whether_ a treatment is effective [@harrer_doingmetaanalysis_2019]. 

In this toolchain walkthrough, an opinionated documentation of a scientific workflow [@gray_codeproofprepare_2019], I computationally step through the packages `multinma::` [@phillippo_multinmanetworkmetaanalysis_2020] and `nnathresh` [@phillippo_sensitivitytreatmentrecommendations_2018] for a network meta-analysis with threshold analysis.  

# thinking through the theory

Bayesian network meta-analysis is a form of meta-analysis, and meta-analysis is form of linear regression. We solve for a line of best fit. How do we describe this particular line? 

## linear regression

$$
y \sim \text{normal}(BX, \sigma^2)
$$

## meta-regression

For the $k$th study's effect, for a random effects model, we assume

$$
y_k \sim \text{normal}(\mu + u_k, \sigma_k^2)\\
u_k \sim \text{normal}(0, \tau^2)
$$

where $\mu$ represents the effect of interest and $u_k$ the heterogeneity of the studies, with spread $\tau^2$.

## Bayesian network meta-analysis

A network meta-analysis relies on a transitivity assumption whereby indirect comparisons can be constructed from direct comparisons. That is, if we have direct comparisons $\delta_{AC}$ and $\delta_{CB}$, we can construct an indirect comparison of differences [@lumley_networkmetaanalysisindirect_2002].
$$
\delta_{AB} = \delta_{AC} + \delta_{CB}
$$

Using this, analogously to $BX$ a coefficients are found for all treatment effects, relative to a control or placebo. 

Since `multinma::` provides tools for Bayesian network meta-analysis, our computational model solves for the posterior [@statrethinkingbook], providing the probability of the parameter of interest, $\theta$, given the data, $x$,
$$
P(\theta|x) = \frac{P(x|\theta)P(\theta)}{P(x)}.
$$
We get the distributions of the mean value of the parameters, the non-data bits, of the model. 

And, using the nomeclature of the documentation in `::nma_thresh`, for  a fixed-effect model, we have prior
$$
d \sim \text{normal}(d_0, \Sigma_d)\\
$$
and likelihood
$$
y\ |\ d \sim \text{normal}(\delta, V)\\
$$
with fixed effect
$$
\delta = Xd + M\mu.
$$

Now to explore this theory in action with an example network meta-analysis. 

# example dataset: parkinsons

We'll use an example dataset from `multinma::` with seven studies' results for pairwise comparisons of five treatments of interest for our continuous response measure, 

> the mean off-time reduction in patients given dopamine agonists as adjunct therapy in Parkinson's disease from 7 trials comparing four active drugs and placebo [`?parkinsons` documentation; @phillippo_multilevelnetworkmetaregression_2020; data source @dias2011nice].


```{r}
# peek at the data
parkinsons %>% 
  head(3)
```

From `?parkinsons` documentation, we know we have a study variable `studyn`, a treatment variable `trtn`, a measure of effect `y`, and standard error of the effect, `se`, sample size `n`.

First step is to convert the raw data to a network object.

```{r}
# create network object
arm_net <- set_agd_arm(parkinsons, 
                      study = studyn,
                      trt = trtn,
                      y = y, 
                      se = se,
                      sample_size = n)

# this is a network object
arm_net

```

Now we've converted our data to a network object, we can inspect the direct and indirect evidence we have. That is which treatments have a pairwise comparison in at least one study.  

```{r}
plot(arm_net, weight_edges = FALSE)
```

We can see the model will be creating indirect comparisons between treatments such 2 and 3, using the direct evidence in studies that compare 1 and 3, as well as 1 and 2. 

# network meta-analysis

We run the following code to fit a random-effects network meta-analysis model. 

```{r eval=FALSE}
nma_results <- nma(arm_net, 
                  trt_effects = "fixed",
                  prior_intercept = normal(scale = 100),
                  prior_trt = normal(scale = 10))
```

```{r include=FALSE}
nma_results <- nma(arm_net, 
                  trt_effects = "fixed",
                  prior_intercept = normal(scale = 100),
                  prior_trt = normal(scale = 10))
```

We assume a prior distribution on $k = 1, \dots, 5$ treatment effects 
$$
d_k \sim \text{normal}(d_4, 100^2) 
$$
Since we assume a likelihood
$$
y\ |\ d \sim \text{normal}(\delta, V)\\
$$
with fixed effect
$$
\delta = Xd + M\mu
$$
our model will give us estimates of $d$, $mu$ and $V$. 


```{r}
nma_results 
```

When we plot the posteriors and with their priors, we see estimates for $M$, the coefficient for study terms, $\mu$, and as well as $X$, the coefficient for treatment effects.  

```{r}
plot_prior_posterior(nma_results)
```

This is measure a mean off-time _reduction_, so I assume a negative value is a bad thing. Then we note that $d_1$ has the largest mean off-time reduction. However, to assess these results more robustly, we turn to a threshold analysis. 

# cochrane reporting

Now, we have the a network meta-anlaysis, we turn to [11.6 of Cochrane handbook](https://training.cochrane.org/handbook/current/chapter-11#section-11-6-4) for how to inspect the results of the model [@higgins2019cochrane].  

## contribution 


## intervention effects



## ranking

```{r}
posterior_rank_probs(nma_results) %>% 
  plot()

```

##  incoherence



# threshold analysis

Phillipo _et al._ claim threshold analysis provides a more robust method of assessing confidence in recommendations based on network meta-analysis than the widely-used [] GRADE framework [@phillippo_thresholdanalysisalternative_2019]. The typical results of a network meta-analysis is a 'consistent set of treatment estimates so that coherent recommendations may be made', however there are many reasons we may question the strength of the evidence. In the case of the Parkinsons dataset, we have an estimate of the laudifference of a particular treatment on the mean off-time reduction in patients given dopamine agonists as adjunct therapy, from the default treatment.

> Threshold analysis quantifies precisely how
much the evidence could change (for any reason, such as potential biases or simply sampling
variation) before the recommendation changes, and what the revised recommendation would be. If
it is judged that the evidence could not plausibly change by more than this amount then the recommendation is considered robust, otherwise the recommendation is sensitive to plausible
changes in the evidence [@phillippo_thresholdanalysisalternative_2019].

Threshold analyses are performed at both study level and at contrast level, in either case the result is a set of thresholds that show how much the data point can change before the recommendation changes. We will do a contrast-level threshold analysis on the Parkinsons dataset. 

`::nma_thresh` for random effects model require 

1. the posterior means `means.dk` of the basic treatment parameters $d_k$, 

```{r posterior means}
post_means <- 
  summary(nma_results, pars=c("d")) %>% 
  as.data.frame() %>%
  pull("mean")

```

2. a likelihood `lhood` covariance matrix,


```{r likelihood cov}
# for lhood
likelihood_cov <- 
  diag(parkinsons$se^2)

```



3. the posterior covariance matrix `post`, posterior covariance mtrix of the vector $(\delta^T, \sigma^T, \mu^T)^T$

```{r}
# for posterior
post_cov <-
  summary(nma_results, pars = c("d")) %>% 
  as.data.frame() %>% 
  pull("sd") %>% 
  as.numeric() %>% 
  map_dbl(.f = function(x){x^2}) %>% 
  diag()


```


4. a design matrix `mu.design` for additional covariates,

```{r mudesign}

# a design matrix for mu.design
M <- matrix(0, nrow = nrow(parkinsons), ncol = 7)

for (i in 1:nrow(parkinsons)) {
  if (parkinsons$trtn[i]) M[i, parkinsons$studyn[i]] <- 1
}


```

5. a design matrix `delta.design` for random effects terms.

```{r}
# construct the design mtrix for eazch contrast
X <- matrix(0, nrow = 15, ncol = 6)

for (i in 1:15){
  X[i, parkinsons$trtn[i]-1] <- 1
  if (parkinsons$studyn[i] != 4){
    X[i, parkinsons$studyn[i]-1] <- -1
  }
}


```

With these inputs, we construct a threshold object.

```{r error=TRUE}

# unfortunately this code throws an error
# indicating the construction of the posterior covariance matrix is not correct
thresh <- 
  nma_thresh(
    mean.dk = post_means,
    lhood = likelihood_cov,
    post= post_cov,
    mu.design = M,
    delta.design = X,
    nmatype = "random"
  )


```

It will take some more study to figure out how to do a threshold analysis. So, I'll toolchain walkthrough, an opinionated documentation of a scientific workflow [@gray_codeproofprepare_2019], through the vignette for threshold analysis, and try to connect it to the structure of the model as mathematical objects. Already I can see the dimensions of the matrices I constructed are not correct.

# the math of `::nma_thresh`

Prior:

$$
d \sim N(d_0, \Sigma_d)
$$
Likelihood:
$$
y | d \sim N(\delta, V)
$$
FE model:
$$
\delta = Xd + M\mu
$$
Which components of these do we need for the threshold analysis?

1. the posterior means `means.dk` of the basic treatment parameters $d_k$

> So that would be the $d$ in $\delta = Xd + M\mu$? 

2. 

# `nmathresh::` example: social anxiety 

In this section, I toolchain walkthrough through the code provided as an example in Phillipo _et al._'s threshold analysis manuscript [@phillippo_thresholdanalysisalternative_2019]. 

The data provided are from a network meta-analysis of social anxiety with 41 treatments in 17 classes over 100 studies. 

1. the posterior means `means.dk` of the basic treatment parameters $d_k$, 



# references

